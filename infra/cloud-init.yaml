#cloud-config
package_update: true
package_upgrade: true

packages:
  - curl
  - ca-certificates
  - apt-transport-https

runcmd:
  # Disable swap (required for Kubernetes)
  - swapoff -a
  - sed -i '/ swap / s/^/#/' /etc/fstab

  # Install k3s
  - curl -sfL https://get.k3s.io | sh -

  # Enable kubectl for root
  - mkdir -p /root/.kube
  - cp /etc/rancher/k3s/k3s.yaml /root/.kube/config
  - chmod 600 /root/.kube/config

  # Make sure k3s is running
  - systemctl enable k3s
  - systemctl start k3s
